"""Vulnerability demo showcasing all 40+ vulnerabilities."""

from typing import List
import sys
from pathlib import Path

# Add parent directory to path for imports
sys.path.insert(0, str(Path(__file__).parent.parent))

from apps.base_app import BaseLLMApp
from apps.simple_model_app import SimpleModelApp
from apps.rag_app import RAGApp
from apps.chatbot_app import ChatbotApp
from apps.agent_app import AgentApp
from demos.base_demo import BaseDemo
from deepteam.vulnerabilities import (
    # Responsible AI
    Bias,
    Toxicity,
    # Data Privacy
    PIILeakage,
    PromptLeakage,
    # Security
    BFLA,
    BOLA,
    RBAC,
    SSRF,
    SQLInjection,
    ShellInjection,
    DebugAccess,
    # Safety
    IllegalActivity,
    GraphicContent,
    PersonalSafety,
    ChildProtection,
    # Business
    Misinformation,
    IntellectualProperty,
    Competition,
    # Agentic
    GoalTheft,
    RecursiveHijacking,
    ExcessiveAgency,
    Robustness,
    # Other
    Ethics,
    Fairness,
)
from deepteam.attacks.single_turn import PromptInjection
from config.settings import Settings


class VulnerabilityDemo(BaseDemo):
    """Demo showcasing all 40+ vulnerabilities available in DeepTeam."""
    
    def __init__(self, settings: Settings = None):
        """Initialize vulnerability demo.
        
        Args:
            settings: Settings instance (optional)
        """
        super().__init__(
            name="Vulnerability Demo",
            description="Comprehensive showcase of all 40+ vulnerabilities",
            settings=settings,
        )
    
    def get_applications(self) -> List[BaseLLMApp]:
        """Get list of LLM applications to test.
        
        Returns:
            List of application instances
        """
        apps = []
        
        # Simple model app
        apps.append(SimpleModelApp(
            llm_config=self.settings.target_llm,
            settings=self.settings,
            logger=self.logger,
        ))
        
        # RAG app (for PII and prompt leakage)
        apps.append(RAGApp(
            llm_config=self.settings.target_llm,
            settings=self.settings,
            logger=self.logger,
        ))
        
        # Chatbot app (for robustness)
        apps.append(ChatbotApp(
            llm_config=self.settings.target_llm,
            settings=self.settings,
            logger=self.logger,
        ))
        
        # Agent app (for agentic vulnerabilities)
        apps.append(AgentApp(
            llm_config=self.settings.target_llm,
            settings=self.settings,
            logger=self.logger,
        ))
        
        return apps
    
    def get_vulnerabilities(self) -> List:
        """Get list of all vulnerabilities to test.
        
        Returns:
            List of vulnerability instances
        """
        vulnerabilities = []
        
        # Responsible AI
        vulnerabilities.append(Bias(types=["race", "gender", "politics", "religion"]))
        vulnerabilities.append(Toxicity(types=["profanity", "insults", "threats"]))
        
        # Data Privacy
        vulnerabilities.append(PIILeakage(types=["direct_disclosure", "session_leak", "api_and_database_access"]))
        vulnerabilities.append(PromptLeakage(types=["secrets_and_credentials", "instructions", "guard_exposure"]))
        
        # Security
        vulnerabilities.append(BFLA())
        vulnerabilities.append(BOLA())
        vulnerabilities.append(RBAC())
        vulnerabilities.append(SSRF(types=["internal_service_access", "port_scanning", "cloud_metadata_access"]))
        vulnerabilities.append(SQLInjection())
        vulnerabilities.append(ShellInjection())
        vulnerabilities.append(DebugAccess())
        
        # Safety
        vulnerabilities.append(IllegalActivity())
        vulnerabilities.append(GraphicContent())
        vulnerabilities.append(PersonalSafety())
        vulnerabilities.append(ChildProtection())
        
        # Business
        vulnerabilities.append(Misinformation(types=["factual_errors", "unsupported_claims"]))
        vulnerabilities.append(IntellectualProperty())
        vulnerabilities.append(Competition())
        
        # Agentic
        vulnerabilities.append(GoalTheft())
        vulnerabilities.append(RecursiveHijacking())
        vulnerabilities.append(ExcessiveAgency())
        vulnerabilities.append(Robustness(types=["input_overreliance", "hijacking"]))
        
        # Other
        vulnerabilities.append(Ethics())
        vulnerabilities.append(Fairness())
        
        self.logger.info(f"Configured {len(vulnerabilities)} vulnerabilities")
        return vulnerabilities
    
    def get_attacks(self) -> List:
        """Get list of attacks to use.
        
        Returns:
            List of attack instances
        """
        # Use prompt injection as the primary attack method
        return [PromptInjection()]

